# ─────────────────────────────────────────────────────────────────────────────
# One-time Infrastructure Setup – Create Artifact Registry & GCS Bucket
# Run manually via workflow_dispatch. Delete after successful setup.
# ─────────────────────────────────────────────────────────────────────────────
name: Setup Infrastructure

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (check only, no changes)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  GCP_REGION: us-central1
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_STAGING }}

permissions:
  contents: read
  id-token: write

jobs:
  setup:
    name: Create Missing GCP Resources
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Check existing resources
        run: |
          echo "## Infrastructure Check" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"

          echo "### Service Account"
          SA_EMAIL=$(gcloud config get-value account 2>/dev/null)
          echo "Authenticated as: $SA_EMAIL"
          echo "- Authenticated as: \`$SA_EMAIL\`" >> "$GITHUB_STEP_SUMMARY"

          echo ""
          echo "### Artifact Registry Repositories"
          gcloud artifacts repositories list \
            --location=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="table(name,format,createTime)" 2>&1 || echo "No repositories found or no permission"

          echo ""
          echo "### GCS Buckets"
          gcloud storage buckets list \
            --project=${{ env.PROJECT_ID }} \
            --format="table(name,location,storageClass)" 2>&1 || echo "No buckets found or no permission"

          echo ""
          echo "### Enabled APIs"
          gcloud services list --enabled \
            --project=${{ env.PROJECT_ID }} \
            --filter="NAME:(artifactregistry OR run OR storage OR compute OR iam)" \
            --format="value(NAME)" 2>&1 || echo "Cannot list services"

      - name: Enable required APIs
        if: inputs.dry_run == 'false'
        run: |
          echo "Enabling required APIs..."
          gcloud services enable \
            artifactregistry.googleapis.com \
            run.googleapis.com \
            storage.googleapis.com \
            compute.googleapis.com \
            iamcredentials.googleapis.com \
            --project=${{ env.PROJECT_ID }} 2>&1 || echo "Some APIs may already be enabled or SA lacks permission"

      - name: Create Artifact Registry repository
        if: inputs.dry_run == 'false'
        run: |
          REPO_NAME="${{ vars.DOCKER_REPO || 'erp-hr-pay-staging-staging-docker' }}"
          echo "Creating Artifact Registry repo: $REPO_NAME"

          gcloud artifacts repositories create "$REPO_NAME" \
            --repository-format=docker \
            --location=${{ env.GCP_REGION }} \
            --description="Docker images for NHIA HRMS staging" \
            --project=${{ env.PROJECT_ID }} 2>&1 && {
              echo "- Created Artifact Registry repo: \`$REPO_NAME\`" >> "$GITHUB_STEP_SUMMARY"
            } || {
              echo "Repository may already exist or SA lacks artifactregistry.admin permission"
              echo "- Artifact Registry repo: already exists or permission denied" >> "$GITHUB_STEP_SUMMARY"
            }

      - name: Create frontend GCS bucket
        if: inputs.dry_run == 'false'
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-frontend"
          echo "Creating GCS bucket: $BUCKET_NAME"

          gcloud storage buckets create "gs://$BUCKET_NAME" \
            --location=US \
            --uniform-bucket-level-access \
            --project=${{ env.PROJECT_ID }} 2>&1 && {
              echo "- Created GCS bucket: \`$BUCKET_NAME\`" >> "$GITHUB_STEP_SUMMARY"
            } || {
              echo "Bucket may already exist or SA lacks storage.admin permission"
              echo "- GCS bucket: already exists or permission denied" >> "$GITHUB_STEP_SUMMARY"
            }

          # Configure as website
          gcloud storage buckets update "gs://$BUCKET_NAME" \
            --web-main-page-suffix=index.html \
            --web-error-page=index.html 2>&1 || echo "Could not update website config"

          # Make bucket publicly readable for frontend serving
          gcloud storage buckets add-iam-policy-binding "gs://$BUCKET_NAME" \
            --member=allUsers \
            --role=roles/storage.objectViewer 2>&1 || echo "Could not set public access"

      - name: Verify resources
        run: |
          echo ""
          echo "### Final State"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Final Resource State" >> "$GITHUB_STEP_SUMMARY"

          echo "Artifact Registry repos:"
          gcloud artifacts repositories list \
            --location=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="table(name,format)" 2>&1 || echo "Cannot list"

          echo ""
          echo "GCS buckets:"
          gcloud storage buckets list \
            --project=${{ env.PROJECT_ID }} \
            --format="table(name,location)" 2>&1 || echo "Cannot list"

      - name: Print next steps
        run: |
          echo ""
          echo "### Next Steps" >> "$GITHUB_STEP_SUMMARY"
          echo "1. Set GitHub variable \`STAGING_BUCKET\` = \`${{ env.PROJECT_ID }}-frontend\`" >> "$GITHUB_STEP_SUMMARY"
          echo "2. Set GitHub variable \`STAGING_API_URL\` = \`https://erp-hr-pay-staging-staging-api-<hash>.run.app\`" >> "$GITHUB_STEP_SUMMARY"
          echo "3. Set GitHub variable \`GCP_REGION\` = \`us-central1\`" >> "$GITHUB_STEP_SUMMARY"
          echo "4. Re-run the Deploy Staging workflow" >> "$GITHUB_STEP_SUMMARY"
