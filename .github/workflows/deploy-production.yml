# ─────────────────────────────────────────────────────────────────────────────
# Deploy to Production – Build, Snapshot, Migrate, Canary Deploy, Release
# Triggers on push to main branch. Requires environment approval.
# ─────────────────────────────────────────────────────────────────────────────
name: Deploy Production

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

env:
  GCP_REGION: ${{ vars.GCP_REGION || 'us-central1' }}
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID_PRODUCTION }}
  REGISTRY: ${{ vars.GCP_REGION || 'us-central1' }}-docker.pkg.dev
  REPOSITORY: ${{ secrets.GCP_PROJECT_ID_PRODUCTION }}/${{ vars.DOCKER_REPO || 'nhia-hrms-production-production-docker' }}
  BACKEND_IMAGE: backend
  WORKER_IMAGE: celery-worker
  CLOUD_RUN_API: ${{ vars.CLOUD_RUN_API || 'nhia-hrms-production-production-api' }}
  CLOUD_RUN_WORKER: ${{ vars.CLOUD_RUN_WORKER || 'nhia-hrms-production-production-worker' }}
  DB_INSTANCE: ${{ vars.DB_INSTANCE || 'nhia-hrms-production-production-pg' }}

permissions:
  contents: write # For tagging and releases
  id-token: write

jobs:
  # ── 1. Run CI ────────────────────────────────────────────────────────────
  ci:
    name: Run CI
    uses: ./.github/workflows/ci.yml

  # ── 2. Build & Push Images ──────────────────────────────────────────────
  build-and-push:
    name: Build & Push Images
    needs: ci
    runs-on: ubuntu-latest
    environment: production
    outputs:
      image-tag: ${{ steps.meta.outputs.tag }}
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for version tag

      - name: Set image tag
        id: meta
        run: echo "tag=${{ github.sha }}" >> "$GITHUB_OUTPUT"

      - name: Determine version
        id: version
        run: |
          # Get latest tag or start at v1.0.0
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          # Increment patch version
          MAJOR=$(echo "$LATEST_TAG" | cut -d. -f1 | tr -d 'v')
          MINOR=$(echo "$LATEST_TAG" | cut -d. -f2)
          PATCH=$(echo "$LATEST_TAG" | cut -d. -f3)
          NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
          echo "version=$NEW_VERSION" >> "$GITHUB_OUTPUT"
          echo "Version: $NEW_VERSION"

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push backend image
        uses: docker/build-push-action@v6
        with:
          context: HRMS/backend
          file: HRMS/backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push worker image
        uses: docker/build-push-action@v6
        with:
          context: HRMS/backend
          file: HRMS/backend/Dockerfile.celery
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.WORKER_IMAGE }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.WORKER_IMAGE }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.WORKER_IMAGE }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ── 3. Pre-deploy Database Snapshot ─────────────────────────────────────
  pre-deploy-snapshot:
    name: Pre-deploy DB Snapshot
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Trigger Cloud SQL backup
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          DESCRIPTION="pre-deploy-${{ needs.build-and-push.outputs.version }}-${TIMESTAMP}"

          echo "## Pre-deploy Backup" >> "$GITHUB_STEP_SUMMARY"
          echo "Creating backup: ${DESCRIPTION}" >> "$GITHUB_STEP_SUMMARY"

          # Find the actual instance name (contains random suffix)
          INSTANCE=$(gcloud sql instances list \
            --project=${{ env.PROJECT_ID }} \
            --filter="name~${{ env.DB_INSTANCE }}" \
            --format="value(name)" \
            --limit=1)

          if [ -z "$INSTANCE" ]; then
            echo "**WARNING:** Could not find Cloud SQL instance matching ${{ env.DB_INSTANCE }}" >> "$GITHUB_STEP_SUMMARY"
            echo "Skipping backup — instance may not exist yet."
            exit 0
          fi

          gcloud sql backups create \
            --instance="$INSTANCE" \
            --project=${{ env.PROJECT_ID }} \
            --description="$DESCRIPTION" \
            --async

          echo "Backup initiated for instance: ${INSTANCE}" >> "$GITHUB_STEP_SUMMARY"

  # ── 4. Database Migration ───────────────────────────────────────────────
  migrate-database:
    name: Run Migrations
    needs: [build-and-push, pre-deploy-snapshot]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Run migrations via Cloud Run Job
        run: |
          echo "## Database Migration" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"

          gcloud run jobs execute ${{ env.CLOUD_RUN_API }}-migrate \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --wait \
            --format="text" 2>&1 | tee -a "$GITHUB_STEP_SUMMARY" || {
              echo '```' >> "$GITHUB_STEP_SUMMARY"
              echo "**MIGRATION FAILED** — Deployment halted. Backup available for rollback." >> "$GITHUB_STEP_SUMMARY"
              exit 1
            }

          echo '```' >> "$GITHUB_STEP_SUMMARY"

  # ── 5. Canary Deploy Backend ────────────────────────────────────────────
  canary-deploy:
    name: Canary Deploy Backend
    needs: [build-and-push, migrate-database]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Get current serving revision
        id: current
        run: |
          CURRENT=$(gcloud run services describe ${{ env.CLOUD_RUN_API }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --format="value(status.traffic[0].revisionName)" 2>/dev/null || echo "")
          echo "revision=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "Current revision: $CURRENT"

      - name: Deploy new revision (0% traffic)
        id: deploy
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.BACKEND_IMAGE }}:${{ needs.build-and-push.outputs.image-tag }}"

          gcloud run deploy ${{ env.CLOUD_RUN_API }} \
            --image="$IMAGE" \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --no-traffic \
            --tag=canary

          NEW_REVISION=$(gcloud run revisions list \
            --service=${{ env.CLOUD_RUN_API }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --sort-by="~metadata.creationTimestamp" \
            --limit=1 \
            --format="value(metadata.name)")

          echo "revision=$NEW_REVISION" >> "$GITHUB_OUTPUT"
          echo "New revision: $NEW_REVISION"

      - name: "Canary: 10% traffic"
        run: |
          NEW="${{ steps.deploy.outputs.revision }}"
          OLD="${{ steps.current.outputs.revision }}"

          if [ -n "$OLD" ]; then
            gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --to-revisions="${NEW}=10,${OLD}=90"
          else
            gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --to-revisions="${NEW}=10"
          fi

          echo "Traffic: 10% canary, 90% stable"

      - name: "Monitor error rate (5 min at 10%)"
        run: |
          echo "Monitoring error rate for 5 minutes at 10% traffic..."
          sleep 300

          # Query Cloud Monitoring for 5xx error rate
          ERROR_COUNT=$(gcloud monitoring time-series list \
            --project=${{ env.PROJECT_ID }} \
            --filter="resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"${{ env.CLOUD_RUN_API }}\" AND metric.type=\"run.googleapis.com/request_count\" AND metric.labels.response_code_class=\"5xx\"" \
            --interval-start-time="$(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --format="value(points[0].value.int64Value)" 2>/dev/null | head -1 || echo "0")

          TOTAL_COUNT=$(gcloud monitoring time-series list \
            --project=${{ env.PROJECT_ID }} \
            --filter="resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"${{ env.CLOUD_RUN_API }}\" AND metric.type=\"run.googleapis.com/request_count\"" \
            --interval-start-time="$(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --format="value(points[0].value.int64Value)" 2>/dev/null | head -1 || echo "1")

          ERROR_COUNT=${ERROR_COUNT:-0}
          TOTAL_COUNT=${TOTAL_COUNT:-1}

          if [ "$TOTAL_COUNT" -eq 0 ]; then
            echo "No traffic observed — proceeding cautiously"
          else
            ERROR_RATE=$(echo "scale=4; $ERROR_COUNT / $TOTAL_COUNT * 100" | bc)
            echo "Error rate: ${ERROR_RATE}% (${ERROR_COUNT}/${TOTAL_COUNT})"

            THRESHOLD=$(echo "$ERROR_RATE > 1.0" | bc -l)
            if [ "$THRESHOLD" -eq 1 ]; then
              echo "ERROR: Error rate ${ERROR_RATE}% exceeds 1% threshold!"
              echo "Rolling back..."

              OLD="${{ steps.current.outputs.revision }}"
              if [ -n "$OLD" ]; then
                gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
                  --region=${{ env.GCP_REGION }} \
                  --project=${{ env.PROJECT_ID }} \
                  --to-revisions="${OLD}=100"
              fi
              exit 1
            fi
          fi

      - name: "Canary: 50% traffic"
        run: |
          NEW="${{ steps.deploy.outputs.revision }}"
          OLD="${{ steps.current.outputs.revision }}"

          if [ -n "$OLD" ]; then
            gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --to-revisions="${NEW}=50,${OLD}=50"
          else
            gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
              --region=${{ env.GCP_REGION }} \
              --project=${{ env.PROJECT_ID }} \
              --to-revisions="${NEW}=50"
          fi

          echo "Traffic: 50% canary, 50% stable"

      - name: "Monitor error rate (5 min at 50%)"
        run: |
          echo "Monitoring error rate for 5 minutes at 50% traffic..."
          sleep 300

          ERROR_COUNT=$(gcloud monitoring time-series list \
            --project=${{ env.PROJECT_ID }} \
            --filter="resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"${{ env.CLOUD_RUN_API }}\" AND metric.type=\"run.googleapis.com/request_count\" AND metric.labels.response_code_class=\"5xx\"" \
            --interval-start-time="$(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --format="value(points[0].value.int64Value)" 2>/dev/null | head -1 || echo "0")

          TOTAL_COUNT=$(gcloud monitoring time-series list \
            --project=${{ env.PROJECT_ID }} \
            --filter="resource.type=\"cloud_run_revision\" AND resource.labels.service_name=\"${{ env.CLOUD_RUN_API }}\" AND metric.type=\"run.googleapis.com/request_count\"" \
            --interval-start-time="$(date -u -d '5 minutes ago' +%Y-%m-%dT%H:%M:%SZ)" \
            --format="value(points[0].value.int64Value)" 2>/dev/null | head -1 || echo "1")

          ERROR_COUNT=${ERROR_COUNT:-0}
          TOTAL_COUNT=${TOTAL_COUNT:-1}

          if [ "$TOTAL_COUNT" -gt 0 ]; then
            ERROR_RATE=$(echo "scale=4; $ERROR_COUNT / $TOTAL_COUNT * 100" | bc)
            echo "Error rate: ${ERROR_RATE}%"

            THRESHOLD=$(echo "$ERROR_RATE > 1.0" | bc -l)
            if [ "$THRESHOLD" -eq 1 ]; then
              echo "ERROR: Error rate ${ERROR_RATE}% exceeds 1% threshold!"
              echo "Rolling back..."

              OLD="${{ steps.current.outputs.revision }}"
              if [ -n "$OLD" ]; then
                gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
                  --region=${{ env.GCP_REGION }} \
                  --project=${{ env.PROJECT_ID }} \
                  --to-revisions="${OLD}=100"
              fi
              exit 1
            fi
          fi

      - name: "Promote: 100% traffic"
        run: |
          NEW="${{ steps.deploy.outputs.revision }}"

          gcloud run services update-traffic ${{ env.CLOUD_RUN_API }} \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }} \
            --to-revisions="${NEW}=100"

          echo "Traffic: 100% on new revision ${NEW}"

      - name: Deploy Celery worker
        run: |
          IMAGE="${{ env.REGISTRY }}/${{ env.REPOSITORY }}/${{ env.WORKER_IMAGE }}:${{ needs.build-and-push.outputs.image-tag }}"

          gcloud run deploy ${{ env.CLOUD_RUN_WORKER }} \
            --image="$IMAGE" \
            --region=${{ env.GCP_REGION }} \
            --project=${{ env.PROJECT_ID }}

  # ── 6. Deploy Frontend ──────────────────────────────────────────────────
  deploy-frontend:
    name: Deploy Frontend
    needs: ci
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: HRMS/frontend/package-lock.json

      - name: Install dependencies
        working-directory: HRMS/frontend
        run: npm ci

      - name: Build for production
        working-directory: HRMS/frontend
        run: npm run build
        env:
          VITE_API_URL: ${{ vars.PRODUCTION_API_URL }}

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Upload to GCS with cache headers
        run: |
          BUCKET="${{ vars.PRODUCTION_BUCKET }}"

          # Static assets: long cache, immutable
          gcloud storage cp HRMS/frontend/dist/assets/* "gs://${BUCKET}/assets/" \
            --recursive \
            --cache-control="public, max-age=31536000, immutable"

          # HTML: no cache
          gcloud storage cp HRMS/frontend/dist/index.html "gs://${BUCKET}/" \
            --cache-control="no-cache, no-store, must-revalidate"

          # Other root files
          gcloud storage cp HRMS/frontend/dist/* "gs://${BUCKET}/" \
            --cache-control="public, max-age=3600" \
            --no-clobber || true

      - name: Invalidate CDN cache
        run: |
          gcloud compute url-maps invalidate-cdn-cache ${{ vars.FRONTEND_URL_MAP || 'nhia-hrms-production-production-frontend-urlmap' }} \
            --path="/index.html" \
            --project=${{ env.PROJECT_ID }} \
            --async || true

  # ── 7. Smoke Tests ──────────────────────────────────────────────────────
  smoke-tests:
    name: Smoke Tests
    needs: [canary-deploy, deploy-frontend]
    runs-on: ubuntu-latest
    steps:
      - name: API health check
        run: |
          API_URL="${{ vars.PRODUCTION_API_URL }}"
          echo "## Production Smoke Tests" >> "$GITHUB_STEP_SUMMARY"

          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/healthz/")
          if [ "$STATUS" = "200" ]; then
            echo "- [x] Health check: **PASS**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- [ ] Health check: **FAIL** (${STATUS})" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi

      - name: Frontend check
        run: |
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" "https://${{ vars.PRODUCTION_DOMAIN || 'hrms.nhia.gov.gh' }}" || echo "000")
          if [ "$STATUS" = "200" ]; then
            echo "- [x] Frontend: **PASS**" >> "$GITHUB_STEP_SUMMARY"
          else
            echo "- [ ] Frontend: **WARN** (${STATUS})" >> "$GITHUB_STEP_SUMMARY"
          fi

  # ── 8. Post-deploy: Tag, Release, Notify ────────────────────────────────
  post-deploy:
    name: Tag & Release
    needs: [build-and-push, smoke-tests]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Tag commit
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          git tag "$VERSION" "${{ github.sha }}"
          git push origin "$VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" "${PREV_TAG}..HEAD" | head -50)
          else
            CHANGELOG=$(git log --pretty=format:"- %s (%an)" -20)
          fi

          # Write to file for gh release
          echo "$CHANGELOG" > /tmp/changelog.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ needs.build-and-push.outputs.version }}"
          gh release create "$VERSION" \
            --title "$VERSION" \
            --notes-file /tmp/changelog.md \
            --latest

      - name: Notify Slack (optional)
        if: always() && vars.SLACK_WEBHOOK_URL != ''
        run: |
          STATUS="${{ job.status }}"
          VERSION="${{ needs.build-and-push.outputs.version }}"
          EMOJI=$([ "$STATUS" = "success" ] && echo ":rocket:" || echo ":x:")

          curl -s -X POST "${{ vars.SLACK_WEBHOOK_URL }}" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"${EMOJI} Production deploy ${STATUS}: ${VERSION}\nCommit: \`${{ github.sha }}\`\nBy: ${{ github.actor }}\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/${VERSION}|Release> | <${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|Actions>\"
            }" || true
